# Flutter VSCode Extension Framework

A Flutter package that enables you to build VSCode extensions using Flutter for the UI and Dart for the business logic. This package provides annotations, code generation, and tooling to seamlessly integrate Flutter web apps into VSCode extension webviews.

## Features

-   **Annotation-based code generation**: Use `@VSCodeController` and `@VSCodeCommand` annotations to automatically generate TypeScript extension code.
-   **Flutter UI integration**: Build your extension's UI using Flutter widgets.
-   **Bidirectional communication**: Seamless communication between Flutter (Dart) and VSCode (TypeScript).
-   **Extension scaffolding**: Automatic generation of VSCode extension project structure.
-   **Webview compatibility**: Pre-configured for VSCode webview constraints and security policies.
-   **Build automation**: Integrated build scripts for both Flutter and TypeScript compilation.

## Getting started

### Prerequisites

-   **Flutter SDK**: Install from [flutter.dev](https://flutter.dev/docs/get-started/install)
-   **Dart SDK**: Included with Flutter
-   **Node.js**: Install the latest stable version from [nodejs.org](https://nodejs.org/)
-   **VSCode**: For extension development and testing


## Usage

### 1. Create Flutter Project and Generate Extension Scaffold

First, create a web-only Flutter project:

```bash
flutter create --platforms web your_extension_name
cd your_extension_name
```

Then, add these packages to your `pubspec.yaml`:

  ```yaml
  dependencies:
    flutter_vscode: ^0.1.0

  dev_dependencies:
    build_runner: ^2.3.0
  ```

Run `flutter pub get`

Then generate the VSCode extension project structure:

```bash
dart run flutter_vscode:init
```

This command will create:
-   VSCode extension configuration (`package.json`, `tsconfig.json`)
-   TypeScript setup (`src/extension.ts`)
-   Flutter web configuration (`web/` directory with webview-compatible setup)
-   Build scripts (`scripts/compile.sh`) and `.gitignore`

### 2. Define Your Extension Logic

Create a controller class with annotations (e.g., `lib/my_extension_controller.dart`):

```dart
import 'package:flutter_vscode/flutter_vscode.dart';

// IMPORTANT: Add this part directive for code generation
part 'my_extension_controller.g.dart';

@VSCodeController()
abstract class MyExtensionController {
  @VSCodeCommand()
  void sayHello(String name);

  @VSCodeCommand()
  Future<String> openPanel();

  @VSCodeCommand()
  void updateStatusBar(int count);
}
```

### 3. Build Your Flutter UI

Create your Flutter app that uses the generated controller (e.g., `lib/main.dart`):

```dart
import 'package:flutter/material.dart';
import 'my_extension_controller.dart'; // Import your controller

void main() {
  runApp(const MyExtensionApp());
}

class MyExtensionApp extends StatelessWidget {
  const MyExtensionApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'VSCode Extension Demo',
      home: const ExtensionPanel(),
    );
  }
}

class ExtensionPanel extends StatefulWidget {
  const ExtensionPanel({super.key});

  @override
  State<ExtensionPanel> createState() => _ExtensionPanelState();
}

class _ExtensionPanelState extends State<ExtensionPanel> {
  late MyExtensionController _controller;
  int _counter = 0;

  @override
  void initState() {
    super.initState();
    // Use the generated factory method to create controller instance
    _controller = MyExtensionControllerFactory.create();
  }

  void _incrementCounter() {
    setState(() {
      _counter++;
    });

    // Communicate with VSCode extension
    try {
      _controller.updateStatusBar(_counter);
    } catch (e) {
      debugPrint('Could not update VSCode status bar: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('VSCode Extension Demo'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Text('You have clicked the button this many times:'),
            Text(
              '$_counter',
              style: Theme.of(context).textTheme.headlineMedium,
            ),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: _incrementCounter,
              child: const Text('Increment & Update Status Bar'),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 4. Build and Test

1.  Run `npm install` to install TypeScript dependencies.
2.  Run `npm run compile` to build everything (Dart code generation, TypeScript compilation, Flutter web build).
3.  Open VS Code and press F5 to launch the extension development host.

## Project Structure

After running `dart run flutter_vscode:init`, your project will have:

```
├── .vscode/
│   └── launch.json          # VSCode debug configuration (generated by VSCode)
├── lib/
│   └── main.dart           # Your Flutter app
│   └── my_extension_controller.dart # Your extension logic
│   └── my_extension_controller.g.dart # Generated Dart code
├── src/
│   └── extension.ts        # TypeScript extension entry point
│   └── my_extension_controller.handlers.ts # Generated TypeScript handlers
├── web/
│   ├── index.html          # Webview-compatible HTML
│   ├── flutter_bootstrap.js # Flutter web bootstrap (generated)
│   └── manifest.json       # Web app manifest (generated by Flutter)
├── scripts/
│   └── compile.sh          # Build automation script
├── package.json            # VSCode extension configuration
├── tsconfig.json           # TypeScript configuration
└── pubspec.yaml           # Flutter/Dart dependencies
```

## Generated Files

The build process automatically generates:
-   `*.handlers.ts` - TypeScript command handlers from your Dart annotations (output to `src/`)
-   `*.g.dart` - Dart implementation classes for your controllers
-   `flutter_bootstrap.js` - Webview communication bridge
-   Modified `web/index.html` (after `compile.sh` moves `index.html.temp`)

### Communicating from VSCode to Flutter

While the `@VSCodeCommand` annotations are great for Flutter-to-VSCode communication, you might need to send messages from the VSCode extension back to your Flutter UI. This is where the `WebviewMessageHandler` comes in.

You can use it in your Flutter app to listen for messages sent from the TypeScript side of your extension.

**1. Initialize the handler in your Flutter app:**

```dart
import 'package:flutter_vscode/flutter_vscode.dart';

// ... in your widget's state

late final WebviewMessageHandler _messageHandler;

@override
void initState() {
  super.initState();
  _messageHandler = WebviewMessageHandler()
    ..setMessageHandler((message) {
      // Handle the message from VSCode
      print('Received message from VSCode: ${message.command} - ${message.params} - ${message.requestId} - ${message.error} - ${message.result}');
    });
}

@override
void dispose() {
  _messageHandler.dispose();
  super.dispose();
}
```

## Additional Information

### Webview Constraints

This package handles VSCode webview limitations:
-   Content Security Policy (CSP) compliance
-   Local resource loading restrictions
-   History API compatibility
-   Remote resource blocking

### Build Integration

The `scripts/compile.sh` script handles:
1.  Dart code generation with `build_runner`
2.  Moving `web/index.html.temp` to `web/index.html`
3.  Flutter web build with webview-specific flags (`--no-web-resources-cdn --csp `) - these are necessary to comply with extension rules on external code

### Contributing

Contributions are welcome! Please see our [contributing guidelines](CONTRIBUTING.md) for details.

### Troubleshooting

If you encounter issues:
-   Ensure your `pubspec.yaml` has the correct dependencies.
-   Run `flutter pub get` to get latest dependencies.
-   Check for typos in your `part` declarations.
-   Validate VSCode and Flutter logs for hints.
-   Ensure Node.js is installed and npm dependencies are resolved.

### Issues

Report bugs and feature requests on our [GitHub issues page](https://github.com/your-repo/flutter_vscode/issues).
